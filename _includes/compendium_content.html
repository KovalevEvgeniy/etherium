{% comment %} Контент компендиума - независимая версия {% endcomment %}

{% assign grouped_pages = "" | split: "" %}
{% for page in site.pages %}
{% assign path_parts = page.path | split: "/" %}
{% assign filename = path_parts | last %}
{% if path_parts[0] == "data" and filename != "index.md" %}
{% assign grouped_pages = grouped_pages | push: page %}
{% endif %}
{% endfor %}

{% assign sections = "" | split: "" %}
{% for page in grouped_pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts.size > 1 %}
{% assign section = path_parts[1] %}
{% unless sections contains section %}
{% assign sections = sections | push: section %}
{% endunless %}
{% endif %}
{% endfor %}

{% comment %} Создаем собственную сортировку для контента - исправленная версия {% endcomment %}
{% assign content_sections_with_order = "" | split: "" %}
{% for section in sections %}
{% assign section_info = "" | split: "" %}
{% assign section_title = section | capitalize %}
{% assign section_protected = false %}
{% assign should_skip = false %}
{% assign section_order = 999999 %}

{% comment %} Ищем index.md файл для этого раздела {% endcomment %}
{% for page in site.pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts[0] == "data" and path_parts[1] == section and path_parts.size == 3 and path_parts.last == "index.md" %}
{% if page.hidden == true %}
{% assign should_skip = true %}
{% break %}
{% endif %}
{% assign section_title = page.title %}
{% assign section_protected = page.protected %}
{% if page.order %}
{% assign section_order = page.order %}
{% endif %}
{% endif %}
{% endfor %}

{% comment %} Пропускаем скрытые и защищенные разделы {% endcomment %}
{% unless should_skip or section_protected == true %}
{% assign padded_order = "000" | append: section_order %}
{% assign padded_order = padded_order | slice: -3, 3 %}
{% assign sort_key = padded_order | append: "|" | append: section_title %}

{% assign section_info = section_info | push: sort_key %}
{% assign section_info = section_info | push: section_title %}
{% assign section_info = section_info | push: section_protected %}
{% assign section_info = section_info | push: section %}
{% assign content_sections_with_order = content_sections_with_order | push: section_info %}
{% endunless %}
{% endfor %}

{% assign content_sorted_sections = content_sections_with_order | sort %}

{% comment %} Начинаем рендерить контент {% endcomment %}
{% for section_info in content_sorted_sections %}
{% assign section = section_info[3] %}
{% assign section_protected = section_info[2] %}
{% assign section_title = section_info[1] %}
{% assign sort_key = section_info[0] %}

{% comment %} Пропускаем скрытые и защищенные разделы {% endcomment %}
{% unless section == "hidden" or section_protected == true %}

## {{ section_title }}

{% assign subsections = "" | split: "" %}
{% for page in grouped_pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts[1] == section and path_parts.size > 3 %}
{% assign subsection = path_parts[2] %}
{% unless subsections contains subsection %}
{% assign subsections = subsections | push: subsection %}
{% endunless %}
{% endif %}
{% endfor %}

{% comment %} Сортируем подразделы - исправленная версия {% endcomment %}
{% assign content_subsections_with_order = "" | split: "" %}
{% for subsection in subsections %}
{% assign subsection_info = "" | split: "" %}
{% assign subsection_title = subsection | capitalize %}
{% assign subsection_protected = false %}
{% assign should_skip = false %}
{% assign subsection_order = 999999 %}

{% comment %} Ищем index.md файл для подраздела {% endcomment %}
{% for page in site.pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts[0] == "data" and path_parts[1] == section and path_parts[2] == subsection and path_parts.size == 4 and path_parts.last == "index.md" %}
{% if page.hidden == true %}
{% assign should_skip = true %}
{% break %}
{% endif %}
{% assign subsection_title = page.title %}
{% assign subsection_protected = page.protected %}
{% if page.order %}
{% assign subsection_order = page.order %}
{% endif %}
{% endif %}
{% endfor %}

{% unless should_skip or subsection_protected == true %}
{% assign padded_subsection_order = "000" | append: subsection_order %}
{% assign padded_subsection_order = padded_subsection_order | slice: -3, 3 %}
{% assign subsection_sort_key = padded_subsection_order | append: "|" | append: subsection_title %}

{% assign subsection_info = subsection_info | push: subsection_sort_key %}
{% assign subsection_info = subsection_info | push: subsection_title %}
{% assign subsection_info = subsection_info | push: subsection_protected %}
{% assign subsection_info = subsection_info | push: subsection %}
{% assign content_subsections_with_order = content_subsections_with_order | push: subsection_info %}
{% endunless %}
{% endfor %}

{% assign content_sorted_subsections = content_subsections_with_order | sort %}

{% comment %} Сначала включаем основные страницы раздела {% endcomment %}
{% assign section_pages = "" | split: "" %}
{% for page in grouped_pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts[1] == section and path_parts.size == 3 %}
{% assign page_info = "" | split: "" %}
{% assign page_order = 999999 %}
{% if page.order %}
{% assign page_order = page.order %}
{% endif %}
{% assign page_info = page_info | push: page_order %}
{% assign page_info = page_info | push: page.title %}
{% assign page_info = page_info | push: page %}
{% assign section_pages = section_pages | push: page_info %}
{% endif %}
{% endfor %}

{% assign sorted_section_pages = section_pages | sort %}
{% for page_info in sorted_section_pages %}
{% assign page = page_info[2] %}
{% unless page.hidden == true or page.protected == true %}

### {{ page.title }}

{% assign content_without_frontmatter = page.content %}
{{ content_without_frontmatter | liquify | markdownify }}

---

{% endunless %}
{% endfor %}

{% comment %} Затем обрабатываем подразделы {% endcomment %}
{% for subsection_info in content_sorted_subsections %}
{% assign subsection = subsection_info[3] %}
{% assign subsection_protected = subsection_info[2] %}
{% assign subsection_title = subsection_info[1] %}

{% comment %} Пропускаем защищенные подразделы {% endcomment %}
{% unless subsection_protected == true %}

### {{ subsection_title }}

{% assign subsubsections = "" | split: "" %}
{% for page in grouped_pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts[1] == section and path_parts[2] == subsection and path_parts.size > 4 %}
{% assign subsubsection = path_parts[3] %}
{% unless subsubsections contains subsubsection %}
{% assign subsubsections = subsubsections | push: subsubsection %}
{% endunless %}
{% endif %}
{% endfor %}

{% comment %} Сортируем подподразделы - исправленная версия {% endcomment %}
{% assign content_subsubsections_with_order = "" | split: "" %}
{% for subsubsection in subsubsections %}
{% assign subsubsection_info = "" | split: "" %}
{% assign subsubsection_title = subsubsection | capitalize %}
{% assign subsubsection_protected = false %}
{% assign should_skip = false %}
{% assign subsubsection_order = 999999 %}

{% comment %} Ищем index.md файл для подподраздела {% endcomment %}
{% for page in site.pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts[0] == "data" and path_parts[1] == section and path_parts[2] == subsection and path_parts[3] == subsubsection and path_parts.size == 5 and path_parts.last == "index.md" %}
{% if page.hidden == true %}
{% assign should_skip = true %}
{% break %}
{% endif %}
{% assign subsubsection_title = page.title %}
{% assign subsubsection_protected = page.protected %}
{% if page.order %}
{% assign subsubsection_order = page.order %}
{% endif %}
{% endif %}
{% endfor %}

{% unless should_skip or subsubsection_protected == true %}
{% assign padded_subsubsection_order = "000" | append: subsubsection_order %}
{% assign padded_subsubsection_order = padded_subsubsection_order | slice: -3, 3 %}
{% assign subsubsection_sort_key = padded_subsubsection_order | append: "|" | append: subsubsection_title %}

{% assign subsubsection_info = subsubsection_info | push: subsubsection_sort_key %}
{% assign subsubsection_info = subsubsection_info | push: subsubsection_title %}
{% assign subsubsection_info = subsubsection_info | push: subsubsection_protected %}
{% assign subsubsection_info = subsubsection_info | push: subsubsection %}
{% assign content_subsubsections_with_order = content_subsubsections_with_order | push: subsubsection_info %}
{% endunless %}
{% endfor %}

{% assign content_sorted_subsubsections = content_subsubsections_with_order | sort %}

{% comment %} Страницы подраздела с сортировкой по order - исправленная версия {% endcomment %}
{% assign subsection_pages_with_order = "" | split: "" %}
{% for page in grouped_pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts[1] == section and path_parts[2] == subsection and path_parts.size == 4 %}
{% assign page_info = "" | split: "" %}
{% assign page_order = 999999 %}
{% if page.order %}
{% assign page_order = page.order %}
{% endif %}
{% assign padded_page_order = "000" | append: page_order %}
{% assign padded_page_order = padded_page_order | slice: -3, 3 %}
{% assign page_sort_key = padded_page_order | append: "|" | append: page.title %}
{% assign page_info = page_info | push: page_sort_key %}
{% assign page_info = page_info | push: page.title %}
{% assign page_info = page_info | push: page %}
{% assign subsection_pages_with_order = subsection_pages_with_order | push: page_info %}
{% endif %}
{% endfor %}

{% assign sorted_subsection_pages = subsection_pages_with_order | sort %}
{% for page_info in sorted_subsection_pages %}
{% assign page = page_info[2] %}
{% unless page.hidden == true or page.protected == true %}

#### {{ page.title }}

{% assign content_without_frontmatter = page.content %}
{{ content_without_frontmatter | liquify | markdownify }}

---

{% endunless %}
{% endfor %}

{% comment %} Обрабатываем подподразделы {% endcomment %}
{% for subsubsection_info in content_sorted_subsubsections %}
{% assign subsubsection = subsubsection_info[3] %}
{% assign subsubsection_protected = subsubsection_info[2] %}
{% assign subsubsection_title = subsubsection_info[1] %}

{% comment %} Пропускаем защищенные подподразделы {% endcomment %}
{% unless subsubsection_protected == true %}

#### {{ subsubsection_title }}

{% assign subsubsection_pages_with_order = "" | split: "" %}
{% for page in grouped_pages %}
{% assign path_parts = page.path | split: "/" %}
{% if path_parts[1] == section and path_parts[2] == subsection and path_parts[3] == subsubsection %}
{% assign page_info = "" | split: "" %}
{% assign page_order = 999999 %}
{% if page.order %}
{% assign page_order = page.order %}
{% endif %}
{% assign padded_page_order = "000" | append: page_order %}
{% assign padded_page_order = padded_page_order | slice: -3, 3 %}
{% assign page_sort_key = padded_page_order | append: "|" | append: page.title %}
{% assign page_info = page_info | push: page_sort_key %}
{% assign page_info = page_info | push: page.title %}
{% assign page_info = page_info | push: page %}
{% assign subsubsection_pages_with_order = subsubsection_pages_with_order | push: page_info %}
{% endif %}
{% endfor %}

{% assign sorted_subsubsection_pages = subsubsection_pages_with_order | sort %}
{% for page_info in sorted_subsubsection_pages %}
{% assign page = page_info[2] %}
{% unless page.hidden == true or page.protected == true %}

##### {{ page.title }}

{% assign content_without_frontmatter = page.content %}
{{ content_without_frontmatter | liquify | markdownify }}

---

{% endunless %}
{% endfor %}

{% endunless %}
{% endfor %}

{% endunless %}
{% endfor %}

{% endunless %}
{% endfor %}